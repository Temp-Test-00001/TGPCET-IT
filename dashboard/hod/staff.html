<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Staff - TGPCET IT</title>
    <link rel="stylesheet" href="../../css/new-dashboard.css">`n    <link rel="stylesheet" href="../../css/mobile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                <h2>TGPCET IT</h2>
            </div>

            <nav class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Overview</span>
                </a>
                <a href="staff.html" class="nav-link active">
                    <i class="fas fa-users"></i>
                    <span>Staff</span>
                </a>
                <a href="events.html" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                </a>
                <a href="approvals.html" class="nav-link">
                    <i class="fas fa-check-circle"></i>
                    <span>Approvals</span>
                </a>
            </nav>

            <div class="user-profile">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div
                        style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        H
                    </div>
                    <div style="overflow: hidden;">
                        <div
                            style="font-size: 0.875rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            HOD</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);" id="user-email">Loading...</div>
                    </div>
                </div>
                <button id="logout-btn" class="btn btn-outline"
                    style="width: 100%; justify-content: flex-start; gap: 0.5rem; border: none; padding: 0.5rem;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <button class="mobile-toggle" id="mobile-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 style="font-size: 1.25rem; font-weight: 600;">Manage Staff</h1>
            </header>

            <div class="page-content">
                <!-- Actions -->
                <div style="margin-bottom: 2rem; display: flex; justify-content: flex-end;">
                    <button onclick="seedStaffData()" class="btn btn-outline">
                        <i class="fas fa-database" style="margin-right: 0.5rem;"></i> Populate Default Staff
                    </button>
                </div>

                <!-- Add Staff Form -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary); font-size: 1.1rem;">Add New Staff Member
                    </h3>
                    <form id="add-staff-form" class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Name</label>
                            <input type="text" id="staffName" class="form-control" placeholder="e.g. Dr. John Doe"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Designation</label>
                            <input type="text" id="staffDesignation" class="form-control"
                                placeholder="e.g. Assistant Professor" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select id="staffRole" class="form-control">
                                <option value="Teaching">Teaching</option>
                                <option value="Non-Teaching">Non-Teaching</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-bottom: 1rem;">
                            <i class="fas fa-plus" style="margin-right: 0.5rem;"></i> Add Staff
                        </button>
                    </form>
                </div>

                <!-- Staff List -->
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.1rem;">Current Staff</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Designation</th>
                                    <th>Role</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staff-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Staff Modal -->
    <div id="edit-modal" class="modal-backdrop">
        <div class="modal-content">
            <button id="close-modal" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="margin-bottom: 1.5rem; color: var(--primary); font-size: 1.25rem;">Edit Staff Member</h3>
            <form id="edit-staff-form">
                <input type="hidden" id="edit-staff-id">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="edit-staffName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Designation</label>
                    <input type="text" id="edit-staffDesignation" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="edit-staffRole" class="form-control">
                        <option value="Teaching">Teaching</option>
                        <option value="Non-Teaching">Non-Teaching</option>
                    </select>
                </div>
                <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn btn-outline" id="cancel-edit">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script type="module">
        import { auth, signOut, db, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from '../../js/auth.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobile-toggle');
        mobileToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && e.target !== mobileToggle) {
                sidebar.classList.remove('open');
            }
        });

        const staffTableBody = document.getElementById('staff-table-body');
        const addStaffForm = document.getElementById('add-staff-form');
        const editModal = document.getElementById('edit-modal');
        const editStaffForm = document.getElementById('edit-staff-form');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelEditBtn = document.getElementById('cancel-edit');

        // Modal Logic
        function closeModal() {
            editModal.style.display = 'none';
        }
        closeModalBtn.addEventListener('click', closeModal);
        cancelEditBtn.addEventListener('click', closeModal);
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) closeModal();
        });

        // Toast Notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../../login.html';
                return;
            }
            document.getElementById('user-email').textContent = user.email;
            loadStaff();
        });

        async function loadStaff() {
            staffTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem; color: var(--text-muted);">Loading staff data...</td></tr>';
            try {
                const querySnapshot = await getDocs(collection(db, "staff"));
                staffTableBody.innerHTML = '';

                if (querySnapshot.empty) {
                    staffTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem; color: var(--text-muted);">No staff members found. Add one above.</td></tr>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const staff = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500; color: white;">${staff.name}</div>
                        </td>
                        <td>${staff.designation}</td>
                        <td>
                            <span class="badge ${staff.role === 'Teaching' ? 'badge-blue' : 'badge-purple'}">
                                ${staff.role}
                            </span>
                        </td>
                        <td style="text-align: right;">
                            <div style="display: inline-flex; gap: 0.5rem;">
                                <button class="btn-icon edit-btn" data-id="${doc.id}" data-name="${staff.name}" data-designation="${staff.designation}" data-role="${staff.role}" style="color: #60a5fa; background: rgba(96, 165, 250, 0.1);">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon delete-btn" data-id="${doc.id}" style="color: #ef4444; background: rgba(239, 68, 68, 0.1);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    staffTableBody.appendChild(row);
                });
                attachEventListeners();
            } catch (error) {
                console.error("Error loading staff:", error);
                staffTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: #ef4444;">Error loading data. Please try again.</td></tr>';
                showToast("Failed to load staff data", "error");
            }
        }

        function attachEventListeners() {
            // Delete Buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if (confirm('Are you sure you want to delete this staff member?')) {
                        const id = e.currentTarget.dataset.id;
                        try {
                            await deleteDoc(doc(db, "staff", id));
                            showToast("Staff member deleted successfully");
                            loadStaff();
                        } catch (error) {
                            showToast("Error deleting staff: " + error.message, "error");
                        }
                    }
                });
            });

            // Edit Buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    document.getElementById('edit-staff-id').value = btn.dataset.id;
                    document.getElementById('edit-staffName').value = btn.dataset.name;
                    document.getElementById('edit-staffDesignation').value = btn.dataset.designation;
                    document.getElementById('edit-staffRole').value = btn.dataset.role;
                    editModal.style.display = 'flex';
                });
            });
        }

        // Add Staff
        addStaffForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('staffName').value;
            const designation = document.getElementById('staffDesignation').value;
            const role = document.getElementById('staffRole').value;

            try {
                await addDoc(collection(db, "staff"), {
                    name, designation, role,
                    createdAt: new Date().toISOString()
                });
                addStaffForm.reset();
                showToast("Staff member added successfully");
                loadStaff();
            } catch (error) {
                console.error("Error adding staff:", error);
                showToast("Error adding staff: " + error.message, "error");
            }
        });

        // Update Staff
        editStaffForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-staff-id').value;
            const name = document.getElementById('edit-staffName').value;
            const designation = document.getElementById('edit-staffDesignation').value;
            const role = document.getElementById('edit-staffRole').value;

            try {
                await updateDoc(doc(db, "staff", id), {
                    name, designation, role
                });
                closeModal();
                showToast("Staff details updated successfully");
                loadStaff();
            } catch (error) {
                console.error("Error updating staff:", error);
                showToast("Error updating staff: " + error.message, "error");
            }
        });

        // Seed Data Function (Global for onclick)
        window.seedStaffData = async function () {
            const defaultStaff = [
                { name: "Dr. P. S. Borkar", designation: "HOD & Associate Professor", role: "Teaching" },
                { name: "Prof. R. C. Dharmik", designation: "Assistant Professor", role: "Teaching" },
                { name: "Prof. M. R. Pund", designation: "Assistant Professor", role: "Teaching" },
                { name: "Mr. S. S. Doe", designation: "Lab Assistant", role: "Non-Teaching" }
            ];

            if (confirm('This will add default staff members. Continue?')) {
                let addedCount = 0;
                for (const staff of defaultStaff) {
                    try {
                        await addDoc(collection(db, "staff"), {
                            ...staff,
                            createdAt: new Date().toISOString()
                        });
                        addedCount++;
                    } catch (err) {
                        console.error("Error seeding:", err);
                    }
                }
                showToast(`Added ${addedCount} default staff members`);
                loadStaff();
            }
        };

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = '../../index.html');
        });
    </script>
</body>

</html>
