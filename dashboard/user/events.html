<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Events - TGPCET IT</title>
    <link rel="stylesheet" href="../../css/new-dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Load jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Error Banner */
        #error-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #dc2626;
            color: white;
            padding: 1rem;
            text-align: center;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Modal Styles */
        .custom-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .custom-modal-backdrop.active {
            display: flex !important;
            opacity: 1;
        }

        .custom-modal-content {
            background: #1e1e1e;
            color: #ffffff;
            padding: 2rem;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .custom-modal-backdrop.active .custom-modal-content {
            transform: scale(1);
        }
    </style>
</head>

<body>
    <div id="error-banner"></div>

    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                <h2>TGPCET IT</h2>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link"><i class="fas fa-home"></i><span>Overview</span></a>
                <a href="profile.html" class="nav-link"><i class="fas fa-user"></i><span>Profile</span></a>
                <a href="events.html" class="nav-link active"><i class="fas fa-calendar-alt"></i><span>My
                        Events</span></a>
            </nav>
            <div class="user-profile">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div id="user-initial"
                        style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        U</div>
                    <div style="overflow: hidden;">
                        <div id="user-name" style="font-size: 0.875rem; font-weight: 600;">Loading...</div>
                        <div id="user-email" style="font-size: 0.75rem; color: var(--text-muted);">Loading...</div>
                    </div>
                </div>
                <button id="logout-btn" class="btn btn-outline"
                    style="width: 100%; justify-content: flex-start; gap: 0.5rem; border: none; padding: 0.5rem;">
                    <i class="fas fa-sign-out-alt"></i><span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <button class="mobile-toggle" id="mobile-toggle"><i class="fas fa-bars"></i></button>
                <h1 style="font-size: 1.25rem; font-weight: 600;">Events & Applications</h1>
            </header>

            <div class="page-content">
                <!-- Available Events -->
                <section style="margin-bottom: 3rem;">
                    <h2
                        style="margin-bottom: 1.5rem; color: var(--primary); font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem;">
                        Available Events</h2>
                    <div id="available-events"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading events...
                        </div>
                    </div>
                </section>

                <!-- My Applications -->
                <section>
                    <h2
                        style="margin-bottom: 1.5rem; color: var(--text-main); font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem;">
                        My Applications</h2>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>App #</th>
                                        <th>Event</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="my-applications">
                                    <tr>
                                        <td colspan="5"
                                            style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                            Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Rejection Details Modal -->
    <div id="rejectionDetailsModal" class="custom-modal-backdrop">
        <div class="custom-modal-content">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                <h2 style="font-size: 1.25rem; color: var(--danger);">Application Rejected</h2>
                <button onclick="document.getElementById('rejectionDetailsModal').classList.remove('active')"
                    style="background: none; border: none; color: #aaa; cursor: pointer; font-size: 1.5rem;">&times;</button>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; color: #aaa; margin-bottom: 0.5rem; text-transform: uppercase;">Reason
                </h3>
                <p id="modalRejectReason"
                    style="background: rgba(220, 38, 38, 0.1); padding: 1rem; border-radius: 6px; border: 1px solid rgba(220, 38, 38, 0.2); color: #fca5a5;">
                    Loading...</p>
            </div>
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 0.9rem; color: #aaa; margin-bottom: 0.5rem; text-transform: uppercase;">Solution
                </h3>
                <p id="modalRejectSolution"
                    style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    Loading...</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button onclick="document.getElementById('rejectionDetailsModal').classList.remove('active')"
                    class="btn btn-outline" style="flex: 1;">Close</button>
                <a id="modalReapplyBtn" href="#" class="btn btn-primary" style="flex: 1;">Re-apply</a>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. Error Handler ---
        function showError(msg) {
            const banner = document.getElementById('error-banner');
            banner.textContent = "Error: " + msg;
            banner.style.display = 'block';
            console.error(msg);
            setTimeout(() => { banner.style.display = 'none'; }, 5000);
        }
        window.onerror = function (msg, url, line) {
            showError(`${msg} (Line ${line})`);
            return false;
        };

        // --- 2. Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 3. Script Loader ---
        const loadPdfScript = () => {
            return new Promise((resolve, reject) => {
                if (window.PDFGenerator) return resolve(window.PDFGenerator);
                const script = document.createElement('script');
                // Cache busting added here
                script.src = '../../js/pdf-generator.js?v=' + Date.now();
                script.onload = () => resolve(window.PDFGenerator);
                script.onerror = () => reject(new Error("Failed to load PDF script"));
                document.head.appendChild(script);
            });
        };

        // --- 4. Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAbpCJRXBwORZC1_MVaqTVlMOqVoA0CT5w",
            authDomain: "tgpcet-5ef68.firebaseapp.com",
            projectId: "tgpcet-5ef68",
            storageBucket: "tgpcet-5ef68.firebasestorage.app",
            messagingSenderId: "63942237118",
            appId: "1:63942237118:web:d5a181bd04ba0e8ce237ef"
        };

        // --- 5. Init ---
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            console.log("User Events Page Initialized");

            let currentUser = null;

            // Helper function for DD/MM/YY date format
            function formatDateDDMMYY(dateString) {
                if (!dateString) return 'N/A';
                const d = new Date(dateString);
                const day = d.getDate().toString().padStart(2, '0');
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const year = d.getFullYear().toString().slice(-2);
                return `${day}/${month}/${year}`;
            }

            // --- 6. Auth & Load ---
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = '../../login.html';
                    return;
                }
                currentUser = user;
                console.log("User authenticated:", user.uid);

                // Load Profile
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        const name = data.profile?.fullName || user.email.split('@')[0];
                        document.getElementById('user-name').textContent = name;
                        document.getElementById('user-email').textContent = user.email;
                        document.getElementById('user-initial').textContent = name[0].toUpperCase();
                        currentUser.profile = data.profile;
                    }
                } catch (e) { console.error("Profile Load Error", e); }

                // Trigger loads with timeout protection
                Promise.race([
                    loadEvents(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error("Events load timeout")), 8000))
                ]).catch(err => {
                    console.error(err);
                    document.getElementById('available-events').innerHTML = '<div style="color: var(--danger);">Error: ' + err.message + '</div>';
                });

                Promise.race([
                    loadApplications(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error("Applications load timeout")), 8000))
                ]).catch(err => {
                    console.error(err);
                    document.getElementById('my-applications').innerHTML = '<tr><td colspan="5" style="color: var(--danger); text-align: center;">Error: ' + err.message + '</td></tr>';
                });
            });

            async function loadEvents() {
                console.log("Loading events...");
                const container = document.getElementById('available-events');
                try {
                    const snap = await getDocs(collection(db, "events"));
                    console.log("Events loaded:", snap.size);
                    container.innerHTML = '';
                    if (snap.empty) {
                        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 2rem;">No events available at the moment.</div>';
                        return;
                    }
                    snap.forEach(doc => {
                        const e = doc.data();
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.style.background = 'rgba(255,255,255,0.02)';
                        card.style.border = '1px solid rgba(255,255,255,0.05)';
                        card.innerHTML = `
                            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-main);">${e.title}</h3>
                            <p style="color: var(--text-muted); margin-bottom: 0.5rem; font-size: 0.875rem;"><i class="fas fa-clock" style="margin-right: 0.5rem;"></i> ${e.date} | <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i> ${e.venue}</p>
                            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem; line-height: 1.5;">${e.description || 'No description available.'}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1rem;">
                                <span style="color: var(--primary); font-weight: 600; font-size: 1.1rem;">${e.fee > 0 ? 'â‚¹' + e.fee : 'Free'}</span>
                                <span class="badge badge-warning">${e.eventType}</span>
                            </div>
                            <a href="eventregform.html?eventId=${doc.id}" class="btn btn-primary" style="width: 100%; text-decoration: none; text-align: center; display: block;">Apply Now</a>
                        `;
                        container.appendChild(card);
                    });
                } catch (err) {
                    console.error(err);
                    throw err; // Propagate to Promise.race
                }
            }

            async function loadApplications() {
                console.log("Loading applications...");
                const tbody = document.getElementById('my-applications');
                try {
                    const q = query(collection(db, "applications"), where("userId", "==", currentUser.uid));
                    const snap = await getDocs(q);
                    console.log("Applications loaded:", snap.size);
                    tbody.innerHTML = '';
                    if (snap.empty) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 2rem;">You haven\'t applied to any events yet.</td></tr>';
                        return;
                    }

                    const apps = [];
                    snap.forEach(doc => apps.push({ id: doc.id, ...doc.data() }));

                    // Sort by date desc
                    apps.sort((a, b) => new Date(b.appliedAt || 0) - new Date(a.appliedAt || 0));

                    for (const app of apps) {
                        let badgeClass = 'badge-warning';
                        if (app.status === 'approved') badgeClass = 'badge-success';
                        if (app.status === 'rejected') badgeClass = 'badge-danger';

                        // Fetch event for PDF
                        let eventData = { title: app.eventTitle };
                        try {
                            if (app.eventId) {
                                const eventDoc = await getDoc(doc(db, "events", app.eventId));
                                if (eventDoc.exists()) eventData = eventDoc.data();
                            }
                        } catch (e) { console.warn("Event fetch error", e); }

                        const row = document.createElement('tr');
                        let actions = `
                            <button class="btn-pdf btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;">
                                <i class="fas fa-download" style="margin-right: 0.5rem;"></i> ${app.status === 'approved' ? 'Admit Card' : 'Application'}
                            </button>
                        `;
                        if (app.status === 'rejected') {
                            actions += `
                                <button class="btn-reject btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.75rem; margin-left: 0.5rem;">
                                    <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i> Fix Issue
                                </button>
                            `;
                        }

                        row.innerHTML = `
                            <td style="color: var(--primary); font-family: monospace;">${app.applicationNumber || app.id.substring(0, 8)}</td>
                            <td>
                                ${app.eventTitle}
                                ${app.teamName ? `<br><span style="font-size: 0.75rem; color: var(--accent);">Team: ${app.teamName}</span>` : ''}
                            </td>
                            <td style="color: var(--text-muted);">${formatDateDDMMYY(app.appliedAt)}</td>
                            <td><span class="badge ${badgeClass}">${app.status}</span></td>
                            <td>${actions}</td>
                        `;

                        // Bind Events
                        const pdfBtn = row.querySelector('.btn-pdf');
                        if (pdfBtn) pdfBtn.onclick = async () => {
                            try {
                                const pdfGen = await loadPdfScript();
                                if (pdfGen) {
                                    if (app.status === 'approved') pdfGen.generateStampedPDF(currentUser, eventData, app);
                                    else pdfGen.generateApplicationPDF(currentUser, eventData, app);
                                }
                            } catch (e) {
                                showError("PDF Load Error: " + e.message);
                            }
                        };

                        const rejectBtn = row.querySelector('.btn-reject');
                        if (rejectBtn) rejectBtn.onclick = () => {
                            document.getElementById('modalRejectReason').textContent = app.rejectionReason || 'N/A';
                            document.getElementById('modalRejectSolution').textContent = app.rejectionSolution || 'N/A';
                            document.getElementById('modalReapplyBtn').href = `eventregform.html?eventId=${app.eventId}`;
                            document.getElementById('rejectionDetailsModal').classList.add('active');
                        };

                        tbody.appendChild(row);
                    }
                } catch (err) {
                    console.error(err);
                    throw err; // Propagate
                }
            }

            // --- 7. UI Listeners ---
            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth).then(() => window.location.href = '../../index.html');
            });

            // Mobile Sidebar
            const sidebar = document.getElementById('sidebar');
            const mobileToggle = document.getElementById('mobile-toggle');
            mobileToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                sidebar.classList.toggle('open');
            });
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && e.target !== mobileToggle) {
                    sidebar.classList.remove('open');
                }
            });

        } catch (initErr) {
            showError("Init Failed: " + initErr.message);
        }
    </script>
</body>

</html>