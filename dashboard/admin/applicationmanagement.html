<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Management - Admin - TGPCET IT</title>
    <link rel="stylesheet" href="../../css/new-dashboard.css">
    <link rel="stylesheet" href="../../css/mobile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Load jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .app-table {
            width: 100%;
            border-collapse: collapse;
        }

        .app-table th,
        .app-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-glass);
        }

        .app-table th {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .app-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background: rgba(234, 179, 8, 0.2);
            color: #facc15;
        }

        .status-approved {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .status-reversed {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
        }

        .action-btn {
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            margin-right: 0.25rem;
        }

        .btn-reverse {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
        }

        .btn-reverse:hover {
            background: rgba(168, 85, 247, 0.3);
        }

        .btn-admit {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .btn-admit:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .btn-reject {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .btn-reject:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .btn-view {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .btn-view:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid var(--border-glass);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .modal-header h3 {
            color: white;
            margin: 0;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-glass);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .detail-item label {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            display: block;
        }

        .detail-item span {
            color: white;
            font-size: 0.9rem;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--primary);
        }

        .history-item .action {
            font-weight: 500;
            color: white;
            font-size: 0.85rem;
        }

        .history-item .meta {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .history-item .remark {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters input,
        .filters select {
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-glass);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 0.875rem;
        }

        .filters select {
            min-width: 150px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                <h2>TGPCET IT</h2>
            </div>

            <nav class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Overview</span>
                </a>
                <a href="events.html" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                </a>
                <a href="approvals.html" class="nav-link">
                    <i class="fas fa-check-circle"></i>
                    <span>Approvals</span>
                </a>
                <a href="applicationmanagement.html" class="nav-link active">
                    <i class="fas fa-file-alt"></i>
                    <span>Applications</span>
                </a>
                <a href="notifications.html" class="nav-link">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </a>
                <a href="staff.html" class="nav-link">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Staff</span>
                </a>
                <a href="support.html" class="nav-link">
                    <i class="fas fa-headset"></i>
                    <span>Support</span>
                </a>
            </nav>

            <div class="user-profile">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div
                        style="width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        A</div>
                    <div style="overflow: hidden;">
                        <div style="font-size: 0.875rem; font-weight: 600;">Admin</div>
                        <div id="user-email" style="font-size: 0.75rem; color: var(--text-muted);">Loading...</div>
                    </div>
                </div>
                <button id="logout-btn" class="btn btn-outline"
                    style="width: 100%; justify-content: flex-start; gap: 0.5rem; border: none; padding: 0.5rem;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <button class="mobile-toggle" id="mobile-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 style="font-size: 1.25rem; font-weight: 600;">Application Management</h1>
            </header>

            <div class="page-content">
                <div class="card">
                    <div class="filters">
                        <input type="text" id="searchInput" placeholder="Search by name, email, event...">
                        <select id="statusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="reversed">Reversed</option>
                        </select>
                        <select id="eventFilter">
                            <option value="">All Events</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table class="app-table">
                            <thead>
                                <tr>
                                    <th>App #</th>
                                    <th>Applicant</th>
                                    <th>Event</th>
                                    <th>Applied</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appTableBody">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <p>Loading applications...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- View Application Modal -->
    <div class="modal-backdrop" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt" style="margin-right: 0.5rem;"></i>Application Details</h3>
                <button class="modal-close" onclick="closeViewModal()"><i class="fas fa-times"></i></button>
            </div>
            <div id="appDetails"></div>
            <div id="appHistory" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <!-- Action Modal -->
    <div class="modal-backdrop" id="actionModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="actionTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeActionModal()"><i class="fas fa-times"></i></button>
            </div>
            <div id="actionDesc" style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;"></div>
            <form id="actionForm">
                <input type="hidden" id="actionAppId">
                <input type="hidden" id="actionType">
                <div class="form-group">
                    <label>Remark / Reason (Required) *</label>
                    <textarea id="actionRemark" required
                        placeholder="Enter the reason for this action. This will be visible to the participant."></textarea>
                </div>
                <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeActionModal()"
                        style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="actionSubmitBtn" style="flex: 1;">
                        <i class="fas fa-check" style="margin-right: 0.5rem;"></i>Confirm
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, signOut, db, collection, getDocs, doc, addDoc, updateDoc, deleteDoc, getDoc } from '../../js/auth.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const mobileToggle = document.getElementById('mobile-toggle');
        mobileToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && e.target !== mobileToggle) {
                sidebar.classList.remove('open');
            }
        });

        let currentUser = null;
        let allApplications = [];
        let allEvents = [];

        // Auth check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '../../login.html';
                return;
            }
            currentUser = user;
            document.getElementById('user-email').textContent = user.email;

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                if (data.role !== 'admin') {
                    alert('Access denied. Admin only.');
                    window.location.href = '../../index.html';
                    return;
                }
            }
            loadApplications();
            loadEvents();
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = '../../index.html');
        });

        // Format date DD/MM/YY HH:MM
        function formatDateTime(dateStr) {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getFullYear()).slice(-2)} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        async function loadEvents() {
            try {
                const snap = await getDocs(collection(db, "events"));
                const select = document.getElementById('eventFilter');
                snap.forEach(d => {
                    const e = d.data();
                    allEvents.push({ id: d.id, ...e });
                    const opt = document.createElement('option');
                    opt.value = e.title;
                    opt.textContent = e.title;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('Failed to load events:', err);
            }
        }

        async function loadApplications() {
            const tbody = document.getElementById('appTableBody');
            tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></td></tr>`;

            try {
                const q = query(collection(db, "applications"), orderBy("appliedAt", "desc"));
                const snap = await getDocs(q);
                allApplications = [];
                snap.forEach(d => {
                    allApplications.push({ id: d.id, ...d.data() });
                });
                renderApplications(allApplications);
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="fas fa-exclamation-circle" style="color: #f87171;"></i><p>Failed to load applications</p></td></tr>`;
            }
        }

        function renderApplications(list) {
            const tbody = document.getElementById('appTableBody');
            if (list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="fas fa-file-alt"></i><p>No applications found</p></td></tr>`;
                return;
            }

            tbody.innerHTML = list.map(app => {
                const profile = app.teamLeader?.profile || {};
                const status = app.status || 'pending';
                const statusClass = status === 'approved' ? 'status-approved' : status === 'rejected' ? 'status-rejected' : status === 'reversed' ? 'status-reversed' : 'status-pending';

                let actions = `<button class="action-btn btn-view" onclick="viewApp('${app.id}')" title="View Details"><i class="fas fa-eye"></i></button>`;

                if (status === 'approved') {
                    actions += `<button class="action-btn btn-admit" onclick="downloadAdmitCard('${app.id}')" title="Download Admit Card"><i class="fas fa-download"></i></button>`;
                    actions += `<button class="action-btn btn-reverse" onclick="openAction('${app.id}', 'reverse')" title="Reverse Approval"><i class="fas fa-undo"></i></button>`;
                    actions += `<button class="action-btn btn-reject" onclick="openAction('${app.id}', 'reject-approved')" title="Reject"><i class="fas fa-ban"></i></button>`;
                } else if (status === 'pending') {
                    actions += `<button class="action-btn btn-admit" onclick="openAction('${app.id}', 'approve')" title="Approve" style="background: rgba(34,197,94,0.2); color: #4ade80;"><i class="fas fa-check"></i></button>`;
                    actions += `<button class="action-btn btn-reject" onclick="openAction('${app.id}', 'reject')" title="Reject"><i class="fas fa-times"></i></button>`;
                } else if (status === 'rejected' || status === 'reversed') {
                    actions += `<button class="action-btn btn-admit" onclick="openAction('${app.id}', 'approve')" title="Approve" style="background: rgba(34,197,94,0.2); color: #4ade80;"><i class="fas fa-check"></i></button>`;
                }

                return `
                    <tr>
                        <td style="font-family: monospace; font-size: 0.75rem; color: var(--text-muted);">${app.applicationNumber || app.id.substring(0, 8)}</td>
                        <td>
                            <div style="font-weight: 500; color: white;">${app.teamName || profile.fullName || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${app.teamLeader?.email || 'N/A'}</div>
                        </td>
                        <td style="color: var(--text-muted); font-size: 0.85rem;">${app.eventTitle || 'N/A'}</td>
                        <td style="color: var(--text-muted); font-size: 0.8rem;">${formatDateTime(app.appliedAt)}</td>
                        <td><span class="status-badge ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        // Search and Filter
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('eventFilter').addEventListener('change', applyFilters);

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const event = document.getElementById('eventFilter').value;

            const filtered = allApplications.filter(app => {
                const profile = app.teamLeader?.profile || {};
                const matchSearch = !search ||
                    (profile.fullName && profile.fullName.toLowerCase().includes(search)) ||
                    (app.teamLeader?.email && app.teamLeader.email.toLowerCase().includes(search)) ||
                    (app.teamName && app.teamName.toLowerCase().includes(search)) ||
                    (app.eventTitle && app.eventTitle.toLowerCase().includes(search)) ||
                    (app.applicationNumber && app.applicationNumber.toLowerCase().includes(search));
                const matchStatus = !status || app.status === status;
                const matchEvent = !event || app.eventTitle === event;
                return matchSearch && matchStatus && matchEvent;
            });
            renderApplications(filtered);
        }

        // View Application
        window.viewApp = async (appId) => {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;

            const profile = app.teamLeader?.profile || {};
            const detailsDiv = document.getElementById('appDetails');

            detailsDiv.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item"><label>Application #</label><span>${app.applicationNumber || app.id}</span></div>
                    <div class="detail-item"><label>Status</label><span class="status-badge status-${app.status || 'pending'}">${(app.status || 'pending').toUpperCase()}</span></div>
                    <div class="detail-item"><label>Applicant Name</label><span>${profile.fullName || 'N/A'}</span></div>
                    <div class="detail-item"><label>Email</label><span>${app.teamLeader?.email || 'N/A'}</span></div>
                    <div class="detail-item"><label>Mobile</label><span>${profile.mobile || 'N/A'}</span></div>
                    <div class="detail-item"><label>College ID</label><span>${profile.prn || 'N/A'}</span></div>
                    <div class="detail-item"><label>College</label><span>${profile.collegeName || 'N/A'}</span></div>
                    <div class="detail-item"><label>Department</label><span>${profile.department || 'N/A'}</span></div>
                    <div class="detail-item"><label>Event</label><span>${app.eventTitle || 'N/A'}</span></div>
                    <div class="detail-item"><label>Fee Paid</label><span>₹${app.fee || 0}</span></div>
                    <div class="detail-item"><label>Applied On</label><span>${formatDateTime(app.appliedAt)}</span></div>
                    ${app.transactionId ? `<div class="detail-item"><label>UTR/Txn ID</label><span>${app.transactionId}</span></div>` : ''}
                </div>
                ${app.teamName ? `<div style="margin-bottom: 1rem;"><label style="color: var(--text-muted); font-size: 0.75rem;">TEAM NAME</label><div style="color: var(--primary); font-weight: 600;">${app.teamName}</div></div>` : ''}
                ${app.teamMembers && app.teamMembers.length > 0 ? `
                    <div style="margin-bottom: 1rem;">
                        <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.5rem;">TEAM MEMBERS (${app.teamMembers.length})</label>
                        ${app.teamMembers.map((m, i) => `<div style="background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem; font-size: 0.85rem;">${i + 1}. ${m.name} | ${m.email || 'N/A'} | ${m.mobile || 'N/A'}</div>`).join('')}
                    </div>
                ` : ''}
            `;

            // Action History
            const historyDiv = document.getElementById('appHistory');
            if (app.actionHistory && app.actionHistory.length > 0) {
                historyDiv.innerHTML = `
                    <label style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-bottom: 0.5rem;">ACTION HISTORY</label>
                    ${app.actionHistory.map(h => `
                        <div class="history-item">
                            <div class="action">${h.action}</div>
                            <div class="meta">By ${h.by} on ${formatDateTime(h.at)}</div>
                            ${h.remark ? `<div class="remark">"${h.remark}"</div>` : ''}
                        </div>
                    `).join('')}
                `;
            } else {
                historyDiv.innerHTML = `<p style="color: var(--text-muted); font-size: 0.8rem; text-align: center;">No action history</p>`;
            }

            document.getElementById('viewModal').classList.add('active');
        };

        window.closeViewModal = () => {
            document.getElementById('viewModal').classList.remove('active');
        };

        // Action Modal
        window.openAction = (appId, actionType) => {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;

            document.getElementById('actionAppId').value = appId;
            document.getElementById('actionType').value = actionType;
            document.getElementById('actionRemark').value = '';

            let title = '', desc = '', btnColor = '';
            switch (actionType) {
                case 'approve':
                    title = '<i class="fas fa-check-circle" style="color: #4ade80; margin-right: 0.5rem;"></i>Approve Application';
                    desc = `You are about to approve the application for <strong>${app.teamName || app.teamLeader?.profile?.fullName || 'this applicant'}</strong>.`;
                    btnColor = '#22c55e';
                    break;
                case 'reject':
                case 'reject-approved':
                    title = '<i class="fas fa-ban" style="color: #f87171; margin-right: 0.5rem;"></i>Reject Application';
                    desc = actionType === 'reject-approved'
                        ? `You are about to reject an <strong>already approved</strong> application. This will change the status from Approved to Rejected.`
                        : `You are about to reject the application for <strong>${app.teamName || app.teamLeader?.profile?.fullName || 'this applicant'}</strong>.`;
                    btnColor = '#dc2626';
                    break;
                case 'reverse':
                    title = '<i class="fas fa-undo" style="color: #c084fc; margin-right: 0.5rem;"></i>Reverse Approval';
                    desc = `You are about to reverse the approval for <strong>${app.teamName || app.teamLeader?.profile?.fullName || 'this applicant'}</strong>. The status will change from Approved to Reversed.`;
                    btnColor = '#a855f7';
                    break;
            }

            document.getElementById('actionTitle').innerHTML = title;
            document.getElementById('actionDesc').innerHTML = desc;
            document.getElementById('actionSubmitBtn').style.background = btnColor;
            document.getElementById('actionModal').classList.add('active');
        };

        window.closeActionModal = () => {
            document.getElementById('actionModal').classList.remove('active');
        };

        // Action Form Submit
        document.getElementById('actionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const appId = document.getElementById('actionAppId').value;
            const actionType = document.getElementById('actionType').value;
            const remark = document.getElementById('actionRemark').value.trim();

            if (!remark) {
                alert('Remark is required!');
                return;
            }

            const btn = document.getElementById('actionSubmitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                const app = allApplications.find(a => a.id === appId);
                const actionHistory = app.actionHistory || [];

                let newStatus = 'pending';
                let actionText = '';
                switch (actionType) {
                    case 'approve':
                        newStatus = 'approved';
                        actionText = 'Approved';
                        break;
                    case 'reject':
                    case 'reject-approved':
                        newStatus = 'rejected';
                        actionText = actionType === 'reject-approved' ? 'Rejected (was approved)' : 'Rejected';
                        break;
                    case 'reverse':
                        newStatus = 'reversed';
                        actionText = 'Approval Reversed';
                        break;
                }

                actionHistory.push({
                    action: actionText,
                    by: currentUser.email,
                    at: new Date().toISOString(),
                    remark: remark
                });

                await updateDoc(doc(db, "applications", appId), {
                    status: newStatus,
                    actionHistory: actionHistory,
                    lastActionAt: new Date().toISOString(),
                    lastActionBy: currentUser.email,
                    lastRemark: remark
                });

                closeActionModal();
                loadApplications();
            } catch (err) {
                console.error(err);
                alert('Failed to process action: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check" style="margin-right: 0.5rem;"></i>Confirm';
            }
        });

        // Download Admit Card
        window.downloadAdmitCard = async (appId) => {
            const app = allApplications.find(a => a.id === appId);
            if (!app || app.status !== 'approved') {
                alert('Cannot download admit card. Application is not approved.');
                return;
            }

            const profile = app.teamLeader?.profile || {};
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const margin = 15;
            let y = margin;

            // Header
            pdf.setFillColor(30, 41, 59);
            pdf.rect(0, 0, pageWidth, 40, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont('helvetica', 'bold');
            pdf.text('TGPCET IT Department', pageWidth / 2, 18, { align: 'center' });
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'normal');
            pdf.text('ADMIT CARD / REGISTRATION PROOF', pageWidth / 2, 28, { align: 'center' });
            pdf.setFontSize(8);
            pdf.text(`Generated: ${new Date().toLocaleString()}`, pageWidth / 2, 35, { align: 'center' });
            y = 50;

            pdf.setTextColor(0, 0, 0);

            // Application Number
            pdf.setFillColor(240, 240, 240);
            pdf.rect(margin, y, pageWidth - 2 * margin, 12, 'F');
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'bold');
            pdf.text(`Application #: ${app.applicationNumber || app.id}`, margin + 4, y + 8);
            pdf.setTextColor(34, 197, 94);
            pdf.text('APPROVED', pageWidth - margin - 4, y + 8, { align: 'right' });
            y += 18;

            pdf.setTextColor(0, 0, 0);
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);

            // Event Details
            pdf.setFont('helvetica', 'bold');
            pdf.text('EVENT DETAILS', margin, y);
            y += 6;
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Event: ${app.eventTitle || 'N/A'}`, margin, y);
            y += 5;
            pdf.text(`Date: ${app.eventDate || 'TBD'} | Venue: ${app.eventVenue || 'TBD'}`, margin, y);
            y += 10;

            // Participant Details
            pdf.setFont('helvetica', 'bold');
            pdf.text('PARTICIPANT DETAILS', margin, y);
            y += 6;
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Name: ${profile.fullName || 'N/A'}`, margin, y);
            y += 5;
            pdf.text(`Email: ${app.teamLeader?.email || 'N/A'}`, margin, y);
            y += 5;
            pdf.text(`Mobile: ${profile.mobile || 'N/A'} | College ID: ${profile.prn || 'N/A'}`, margin, y);
            y += 5;
            pdf.text(`College: ${profile.collegeName || 'N/A'}`, margin, y);
            y += 5;
            pdf.text(`Department: ${profile.department || 'N/A'} | Year: ${profile.year || 'N/A'}`, margin, y);
            y += 10;

            // Team Details
            if (app.teamName) {
                pdf.setFont('helvetica', 'bold');
                pdf.text('TEAM DETAILS', margin, y);
                y += 6;
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Team Name: ${app.teamName}`, margin, y);
                y += 5;
                if (app.teamMembers && app.teamMembers.length > 0) {
                    pdf.text(`Team Members (${app.teamMembers.length}):`, margin, y);
                    y += 5;
                    app.teamMembers.forEach((m, i) => {
                        pdf.text(`  ${i + 1}. ${m.name} | ${m.email || 'N/A'} | ${m.mobile || 'N/A'}`, margin, y);
                        y += 4;
                    });
                }
                y += 5;
            }

            // Payment Details
            if (app.fee > 0) {
                pdf.setFont('helvetica', 'bold');
                pdf.text('PAYMENT DETAILS', margin, y);
                y += 6;
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Fee Paid: ₹${app.fee}`, margin, y);
                y += 5;
                if (app.transactionId) {
                    pdf.text(`UTR/Transaction ID: ${app.transactionId}`, margin, y);
                    y += 5;
                }
                y += 5;
            }

            // Instructions
            y += 5;
            pdf.setDrawColor(150, 150, 150);
            pdf.line(margin, y, pageWidth - margin, y);
            y += 8;
            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'bold');
            pdf.text('IMPORTANT INSTRUCTIONS:', margin, y);
            y += 5;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(8);
            const instructions = [
                '1. Please carry this admit card along with a valid college ID to the event.',
                '2. Report to the venue at least 30 minutes before the scheduled time.',
                '3. Follow all event guidelines and instructions given by organizers.',
                '4. This admit card is non-transferable.',
                '5. For any queries, contact the IT Department.'
            ];
            instructions.forEach(inst => {
                pdf.text(inst, margin, y);
                y += 4;
            });

            // Footer
            y = pdf.internal.pageSize.getHeight() - 20;
            pdf.setFontSize(8);
            pdf.setTextColor(100, 100, 100);
            pdf.text('This is a computer-generated document. No signature required.', pageWidth / 2, y, { align: 'center' });
            pdf.text('TGPCET IT Department | it-tgpcet.vercel.app', pageWidth / 2, y + 5, { align: 'center' });

            pdf.save(`AdmitCard_${app.applicationNumber || app.id}.pdf`);
        };
    </script>
</body>

</html>